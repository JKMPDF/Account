import{r as o,C as U,b as Y,c as Q,j as e,S as G,B as R,o as z,a as O,m as te,q as le,u as ne,s as re,d as oe,t as de}from"./index-D93vVwhB.js";import{I as M}from"./Input-C3iYqBmf.js";import{T as ie}from"./Textarea-DXj1psJj.js";import{A as ce}from"./accountingGroups-C-_vw-K6.js";import{S as me}from"./stockUnits-D3SLr8Su.js";import{f as ue}from"./exportUtils-JZTId_Jh.js";import{g as xe}from"./pdfGenerator-BheaZc2-.js";const se=({onLedgerCreated:v})=>{const{companyData:I,addLedger:$}=o.useContext(U),{addNotification:k}=Y(),{hideModal:c}=Q(),[h,g]=o.useState(""),[f,m]=o.useState(""),B=o.useMemo(()=>[{value:"",label:"Select Group"},...ce.sort().map(S=>({value:S,label:S}))],[]),L=S=>{if(S.preventDefault(),!h||!f){k("Ledger Name and Group are required.","error");return}if(I!=null&&I.ledgers.some(d=>d.name.toLowerCase()===h.toLowerCase())){k("A ledger with this name already exists.","error");return}const _=$({name:h,group:f});_&&(v(_),c())};return e.jsxs("form",{onSubmit:L,className:"p-6 space-y-4",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900 dark:text-slate-100",children:"Quick Create Ledger"}),e.jsx(M,{label:"Ledger Name",id:"quick-ledger-name",value:h,onChange:S=>g(S.target.value),required:!0}),e.jsx(G,{label:"Group",id:"quick-ledger-group",value:f,onChange:m,options:B,required:!0}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4",children:[e.jsx(R,{type:"button",variant:"secondary",onClick:c,children:"Cancel"}),e.jsx(R,{type:"submit",children:"Create Ledger"})]})]})},ae=({onItemCreated:v})=>{const{companyData:I,addStockItem:$}=o.useContext(U),{addNotification:k}=Y(),{hideModal:c}=Q(),[h,g]=o.useState(""),[f,m]=o.useState(""),[B,L]=o.useState(0),S=o.useMemo(()=>[{value:"",label:"Select Unit"},...me.map(d=>({value:d.split(" ")[0],label:d}))],[]),_=d=>{if(d.preventDefault(),!h||!f){k("Item Name and Unit are required.","error");return}if(I!=null&&I.stockItems.some(t=>t.name.toLowerCase()===h.toLowerCase())){k("A stock item with this name already exists.","error");return}const u=$({name:h,unit:f,gstRate:B});u&&(v(u),c())};return e.jsxs("form",{onSubmit:_,className:"p-6 space-y-4",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900 dark:text-slate-100",children:"Quick Create Stock Item"}),e.jsx(M,{label:"Item Name",id:"quick-item-name",value:h,onChange:d=>g(d.target.value),required:!0}),e.jsx(G,{label:"Unit",id:"quick-item-unit",value:f,onChange:m,options:S,required:!0}),e.jsx(M,{label:"GST Rate (%)",id:"quick-gst-rate",type:"number",value:B,onChange:d=>L(parseFloat(d.target.value)||0)}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4",children:[e.jsx(R,{type:"button",variant:"secondary",onClick:c,children:"Cancel"}),e.jsx(R,{type:"submit",children:"Create Item"})]})]})},he=({stockItem:v,quantity:I,existingAllocations:$,onSave:k})=>{const{hideModal:c}=Q(),h=v.isBatchTracked,[g,f]=o.useState(h&&Array.isArray($)&&$.length>0?$:[{batchNo:"",quantity:I,expiryDate:""}]),[m,B]=o.useState(!h&&Array.isArray($)&&$.length>0?$:Array(I).fill("")),L=(s,l,x)=>{const p=[...g];p[s][l]=x,f(p)},S=()=>f([...g,{batchNo:"",quantity:0,expiryDate:""}]),_=s=>f(g.filter((l,x)=>x!==s)),d=(s,l)=>{const x=[...m];x[s]=l,B(x)},u=o.useMemo(()=>g.reduce((s,l)=>s+Number(l.quantity||0),0),[g]),t=()=>{if(h){if(u!==I){alert(`Total batch quantity (${u}) must match the invoice quantity (${I}).`);return}k(g.filter(s=>s.batchNo&&s.quantity>0))}else{if(m.length!==I){alert(`You must enter ${I} serial numbers.`);return}if(m.some(s=>!s.trim())){alert("All serial number fields must be filled.");return}k(m)}c()};return e.jsxs("div",{className:"p-6",children:[e.jsxs("h3",{className:"text-xl font-bold text-slate-900 dark:text-slate-100 mb-2",children:[h?"Batch Allocation":"Serial Number Entry"," for ",v.name]}),e.jsxs("p",{className:"text-slate-500 dark:text-slate-400 mb-4",children:["Total Quantity: ",e.jsx("span",{className:"font-bold",children:I})]}),h?e.jsxs("div",{className:"space-y-3 max-h-80 overflow-y-auto pr-2",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-2 font-semibold text-xs text-slate-500 dark:text-slate-400",children:[e.jsx("div",{className:"col-span-5",children:"Batch No."}),e.jsx("div",{className:"col-span-3",children:"Quantity"}),e.jsx("div",{className:"col-span-3",children:"Expiry (Optional)"})]}),g.map((s,l)=>e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-center",children:[e.jsx("div",{className:"col-span-5",children:e.jsx(M,{label:"",id:`batchNo-${l}`,value:s.batchNo,onChange:x=>L(l,"batchNo",x.target.value)})}),e.jsx("div",{className:"col-span-3",children:e.jsx(M,{label:"",id:`batchQty-${l}`,type:"number",value:s.quantity,onChange:x=>L(l,"quantity",Number(x.target.value))})}),e.jsx("div",{className:"col-span-3",children:e.jsx(M,{label:"",id:`batchExp-${l}`,type:"date",value:s.expiryDate||"",onChange:x=>L(l,"expiryDate",x.target.value)})}),e.jsx("div",{className:"col-span-1",children:e.jsx(R,{type:"button",variant:"danger",className:"!p-2",onClick:()=>_(l),children:e.jsx(z,{className:"w-5 h-5"})})})]},l)),e.jsxs(R,{type:"button",variant:"secondary",onClick:S,children:[e.jsx(O,{className:"w-4 h-4 mr-1"}),"Add Batch"]}),e.jsxs("div",{className:`text-right font-semibold ${u!==I?"text-red-500":"text-green-500"}`,children:["Total Batch Qty: ",u," / ",I]})]}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 max-h-80 overflow-y-auto pr-2",children:m.map((s,l)=>e.jsx(M,{label:`Serial #${l+1}`,id:`serial-${l}`,value:s,onChange:x=>d(l,x.target.value)},l))}),e.jsxs("div",{className:"mt-6 flex justify-end gap-4",children:[e.jsx(R,{variant:"secondary",onClick:c,children:"Cancel"}),e.jsxs(R,{onClick:t,children:[e.jsx(te,{className:"w-5 h-5 mr-2"})," Save"]})]})]})},ge=({voucherType:v,setVoucherEntries:I,setParentTransactionType:$,existingVoucher:k})=>{const{companyData:c}=o.useContext(U),{ledgers:h,stockItems:g,priceLists:f}=c,{showModal:m}=Q(),[B,L]=o.useState(""),[S,_]=o.useState(null),[d,u]=o.useState(""),[t,s]=o.useState("Intra-State"),[l,x]=o.useState([{id:`item_${Date.now()}`,stockItemId:"",quantity:"",rate:"",amount:0,gstRate:0}]),p=o.useMemo(()=>v==="Sale"||v==="Credit Note",[v]),D=o.useMemo(()=>v==="Credit Note"||v==="Debit Note",[v]),A=o.useMemo(()=>{const n=h.filter(r=>["Sundry Debtors","Sundry Creditors","Bank Accounts","Cash-in-hand"].includes(r.group));return[{value:"",label:"Select Party"},...n.map(r=>({value:r.id,label:r.name}))]},[h]),i=p?"Sales Accounts":"Purchase Accounts",V=p?D?"Sales Return In":"Sales Ledger":D?"Purchase Return Out":"Purchase Ledger",K=o.useMemo(()=>[{value:"",label:"Select Ledger"},...h.filter(n=>n.group===i).map(n=>({value:n.id,label:n.name}))],[h,i]),P=o.useMemo(()=>[{value:"",label:"Select Item"},...g.map(n=>({value:n.id,label:n.name}))],[g]);o.useEffect(()=>{if(k){const n=k.entries.find(b=>{var C;return["Sundry Debtors","Sundry Creditors","Bank Accounts","Cash-in-hand"].includes(((C=h.find(a=>a.id===b.ledgerId))==null?void 0:C.group)||"")}),r=k.entries.find(b=>{var C;return((C=h.find(a=>a.id===b.ledgerId))==null?void 0:C.group)===i});L((n==null?void 0:n.ledgerId)||""),u((r==null?void 0:r.ledgerId)||""),s(k.transactionType||"Intra-State"),r!=null&&r.inventoryAllocations&&x(r.inventoryAllocations.map(b=>{const C=g.find(a=>a.id===b.stockItemId);return{id:`item_${Math.random()}`,...b,quantity:b.quantity,rate:b.rate,amount:b.quantity*b.rate,gstRate:(C==null?void 0:C.gstRate)||0}}))}},[k,h,i,g]),o.useEffect(()=>{const n=h.find(r=>r.id===B);_(n||null),n&&n.state&&(c!=null&&c.details.state)&&typeof c.details.state=="string"&&n.state.trim()&&(n.state.toLowerCase()!==c.details.state.toLowerCase()?s("Inter-State"):s("Intra-State"))},[B,h,c==null?void 0:c.details.state]);const E=(n,r,b)=>{const C=[...l],a={...C[n]};if(a[r]=b,r==="stockItemId"){const N=g.find(w=>w.id===b);if(a.gstRate=(N==null?void 0:N.gstRate)||0,a.rate="",S!=null&&S.priceListId){const w=f.find(y=>y.id===S.priceListId);w&&w.itemRates[b]&&(a.rate=w.itemRates[b])}a.quantity===""&&b&&(a.quantity=1)}const T=parseFloat(String(a.quantity))||0,j=parseFloat(String(a.rate))||0;a.amount=T*j,C[n]=a,x(C)},H=()=>x([...l,{id:`item_${Date.now()}`,stockItemId:"",quantity:"",rate:"",amount:0,gstRate:0}]),X=n=>x(l.filter((r,b)=>b!==n)),W=n=>{m(e.jsx(se,{onLedgerCreated:n}))},Z=n=>{m(e.jsx(ae,{onItemCreated:n}))},ee=n=>{const r=l[n],b=g.find(C=>C.id===r.stockItemId);!b||Number(r.quantity)<=0||m(e.jsx(he,{stockItem:b,quantity:Number(r.quantity),existingAllocations:b.isBatchTracked?r.batches:r.serialNumbers,onSave:C=>{b.isBatchTracked?E(n,"batches",C):E(n,"serialNumbers",C)}}))},q=o.useMemo(()=>{const n=l.reduce((j,N)=>j+(Number(N.amount)||0),0),r={};l.forEach(j=>{const N=Number(j.amount)||0;j.gstRate>0&&N>0&&(r[j.gstRate]||(r[j.gstRate]={taxable:0,cgst:0,sgst:0,igst:0}),r[j.gstRate].taxable+=N)});let b=0,C=0,a=0;c!=null&&c.details.gstApplicable&&Object.entries(r).forEach(([j,N])=>{const w=parseFloat(j);if(t==="Intra-State"){const y=N.taxable*(w/2/100),F=y;N.cgst=y,N.sgst=F,b+=y,C+=F}else{const y=N.taxable*(w/100);N.igst=y,a+=y}});const T=n+b+C+a;return{subTotal:n,cgst:b,sgst:C,igst:a,grandTotal:T,taxSummaryByRate:r}},[l,t,c==null?void 0:c.details.gstApplicable]);return o.useEffect(()=>{$(t);const n=y=>h.find(F=>F.name.toLowerCase()===y.toLowerCase()&&F.group==="Duties & Taxes"),r=n("cgst"),b=n("sgst"),C=n("igst");if(!B||!d||q.grandTotal<=0){I([]);return}const a=v==="Sale"||v==="Debit Note"?"Dr":"Cr",T=a==="Dr"?"Cr":"Dr",j=Date.now();let N=[{id:`inv_entry_${j}_main`,type:T,ledgerId:d,amount:q.subTotal,inventoryAllocations:l.filter(y=>y.stockItemId&&Number(y.quantity)>0).map(y=>({stockItemId:y.stockItemId,quantity:Number(y.quantity),rate:Number(y.rate),batches:y.batches,serialNumbers:y.serialNumbers}))}];q.cgst>0&&r&&N.push({id:`inv_entry_${j}_cgst`,type:T,ledgerId:r.id,amount:q.cgst}),q.sgst>0&&b&&N.push({id:`inv_entry_${j}_sgst`,type:T,ledgerId:b.id,amount:q.sgst}),q.igst>0&&C&&N.push({id:`inv_entry_${j}_igst`,type:T,ledgerId:C.id,amount:q.igst});const w=N.reduce((y,F)=>y+F.amount,0);N.unshift({id:`inv_entry_${j}_party`,type:a,ledgerId:B,amount:w}),I(N)},[B,d,l,q,t,v,h,I,$]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 p-4 bg-slate-100 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx(G,{label:"Party Account",id:"partyLedger",value:B,onChange:L,options:A,required:!0,className:"flex-grow"}),e.jsx(R,{type:"button",variant:"secondary",className:"!p-2",onClick:()=>W(n=>L(n.id)),children:e.jsx(O,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex items-end gap-4",children:[e.jsxs("div",{className:"flex items-end gap-2 flex-grow",children:[e.jsx(G,{label:V,id:"mainLedger",value:d,onChange:u,options:K,required:!0,className:"flex-grow"}),e.jsx(R,{type:"button",variant:"secondary",className:"!p-2",onClick:()=>W(n=>u(n.id)),children:e.jsx(O,{className:"w-5 h-5"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1",children:"Transaction Type"}),e.jsx("div",{className:"px-3 py-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-slate-900 dark:text-slate-100 font-medium text-center",children:t})]})]}),(S==null?void 0:S.address)&&e.jsxs("div",{className:"md:col-span-2 mt-2 text-xs text-slate-500 dark:text-slate-400 bg-slate-200/50 dark:bg-slate-700/50 p-2 rounded-md border border-slate-300 dark:border-slate-600",children:[e.jsxs("p",{className:"font-semibold",children:[S.name," (",S.state,")"]}),S.gstNo&&e.jsxs("p",{className:"font-semibold mt-1",children:["GSTIN: ",S.gstNo]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-2 font-semibold text-slate-500 dark:text-slate-400 px-2 pb-2 border-b border-slate-300 dark:border-slate-600 text-sm min-w-[700px]",children:[e.jsx("div",{className:"col-span-4",children:"Item"}),e.jsx("div",{className:"col-span-1 text-right",children:"Qty"}),e.jsx("div",{className:"col-span-2 text-right",children:"Rate"}),e.jsx("div",{className:"col-span-2 text-right",children:"Amount"}),e.jsx("div",{className:"col-span-2 text-right",children:"GST"}),e.jsx("div",{className:"col-span-1"})]}),e.jsx("div",{className:"space-y-2 mt-2 min-w-[700px]",children:l.map((n,r)=>{const b=g.find(a=>a.id===n.stockItemId),C=b&&(b.isBatchTracked||b.isSerialTracked);return e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-start",children:[e.jsxs("div",{className:"col-span-4 flex items-start gap-2",children:[e.jsx(G,{label:"",id:`item-${r}`,value:n.stockItemId,onChange:a=>E(r,"stockItemId",a),options:P,className:"flex-grow"}),e.jsx(R,{type:"button",variant:"secondary",className:"!p-2 mt-1",onClick:()=>Z(a=>E(r,"stockItemId",a.id)),children:e.jsx(O,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx(M,{label:"",id:`qty-${r}`,type:"text",value:n.quantity,onChange:a=>E(r,"quantity",a.target.value),className:"text-right",placeholder:"0"}),C&&e.jsx(R,{type:"button",onClick:()=>ee(r),className:"!p-1 !text-xs w-full mt-1",children:b.isBatchTracked?"Batches":"Serials"})]}),e.jsx("div",{className:"col-span-2",children:e.jsx(M,{label:"",id:`rate-${r}`,type:"text",value:n.rate,onChange:a=>E(r,"rate",a.target.value),className:"text-right",placeholder:"0.00"})}),e.jsx("div",{className:"col-span-2",children:e.jsx(M,{label:"",id:`amount-${r}`,type:"number",value:n.amount.toFixed(2),readOnly:!0,className:"bg-slate-100 dark:bg-slate-800 text-right"})}),e.jsx("div",{className:"col-span-2",children:e.jsx(M,{label:"",id:`gst-${r}`,type:"text",value:`${n.gstRate}% | ${(n.amount*n.gstRate/100).toFixed(2)}`,readOnly:!0,className:"bg-slate-100 dark:bg-slate-800 text-right text-xs"})}),e.jsx("div",{className:"col-span-1 mt-1",children:e.jsx(R,{type:"button",variant:"danger",onClick:()=>X(r),className:"!p-2",children:e.jsx(z,{className:"w-5 h-5"})})})]},n.id)})})]}),e.jsxs(R,{type:"button",variant:"secondary",onClick:H,className:"mt-4",children:[e.jsx(O,{className:"w-5 h-5 mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"pt-4 mt-4 border-t border-slate-200 dark:border-slate-700",children:e.jsx("div",{className:"flex justify-end",children:e.jsxs("div",{className:"w-full max-w-md bg-slate-100 dark:bg-slate-900/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700 space-y-4",children:[e.jsxs("div",{className:"flex justify-between font-semibold text-slate-700 dark:text-slate-300",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{className:"font-mono",children:q.subTotal.toFixed(2)})]}),(c==null?void 0:c.details.gstApplicable)&&Object.keys(q.taxSummaryByRate).length>0&&e.jsxs("div",{className:"text-xs border-t border-b border-slate-200 dark:border-slate-700 py-2 space-y-1",children:[e.jsxs("div",{className:`grid ${t==="Intra-State"?"grid-cols-4":"grid-cols-3"} font-bold text-slate-500 dark:text-slate-400 gap-2`,children:[e.jsx("div",{className:"text-left",children:"Rate"}),e.jsx("div",{className:"text-right",children:"Taxable"}),e.jsx("div",{className:"text-right",children:t==="Intra-State"?"CGST":"IGST"}),t==="Intra-State"&&e.jsx("div",{className:"text-right",children:"SGST"})]}),Object.entries(q.taxSummaryByRate).map(([n,r])=>e.jsxs("div",{className:`grid ${t==="Intra-State"?"grid-cols-4":"grid-cols-3"} font-mono text-slate-700 dark:text-slate-300 gap-2`,children:[e.jsxs("div",{className:"text-left",children:[n,"%"]}),e.jsx("div",{className:"text-right",children:r.taxable.toFixed(2)}),e.jsx("div",{className:"text-right",children:t==="Intra-State"?r.cgst.toFixed(2):r.igst.toFixed(2)}),t==="Intra-State"&&e.jsx("div",{className:"text-right",children:r.sgst.toFixed(2)})]},n))]}),e.jsxs("div",{className:"space-y-1 text-sm text-slate-700 dark:text-slate-300",children:[(c==null?void 0:c.details.gstApplicable)&&t==="Intra-State"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total CGST:"})," ",e.jsx("span",{className:"font-mono",children:q.cgst.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total SGST:"})," ",e.jsx("span",{className:"font-mono",children:q.sgst.toFixed(2)})]})]}),(c==null?void 0:c.details.gstApplicable)&&t==="Inter-State"&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total IGST:"})," ",e.jsx("span",{className:"font-mono",children:q.igst.toFixed(2)})]})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t border-slate-300 dark:border-slate-600 pt-2 text-sky-600 dark:text-sky-400",children:[e.jsx("span",{children:"Grand Total:"}),e.jsx("span",{className:"font-mono",children:q.grandTotal.toFixed(2)})]})]})})})]})},pe=({setVoucherEntries:v})=>{const{companyData:I}=o.useContext(U),{stockItems:$,godowns:k}=I,{showModal:c}=Q(),{addNotification:h}=Y(),[g,f]=o.useState([{id:`item_${Date.now()}`,stockItemId:"",sourceGodownId:"",destGodownId:"",quantity:1,rate:0,amount:0}]),m=o.useMemo(()=>[{value:"",label:"Select Item"},...$.map(t=>({value:t.id,label:t.name}))],[$]),B=o.useMemo(()=>[{value:"",label:"Select Godown"},...k.map(t=>({value:t.id,label:t.name}))],[k]),L=(t,s,l)=>{const x=[...g],p={...x[t]};p[s]=l,(s==="quantity"||s==="rate")&&(p.amount=(Number(p.quantity)||0)*(Number(p.rate)||0)),x[t]=p,f(x)},S=()=>f([...g,{id:`item_${Date.now()}`,stockItemId:"",sourceGodownId:"",destGodownId:"",quantity:1,rate:0,amount:0}]),_=t=>f(g.filter((s,l)=>l!==t)),d=t=>{c(e.jsx(ae,{onItemCreated:t}))},u=o.useMemo(()=>g.reduce((t,s)=>t+s.amount,0),[g]);return o.useEffect(()=>{const t=g.filter(A=>A.stockItemId&&A.quantity>0&&A.sourceGodownId&&A.destGodownId&&A.sourceGodownId!==A.destGodownId);if(t.length===0){v([]);return}const s=Date.now(),l=t.map(A=>({stockItemId:A.stockItemId,quantity:A.quantity,rate:A.rate,godownId:A.sourceGodownId})),x=t.map(A=>({stockItemId:A.stockItemId,quantity:A.quantity,rate:A.rate,godownId:A.destGodownId})),p=t.reduce((A,i)=>A+i.amount,0),D=[{id:`sj_entry_${s}_consume`,type:"Cr",ledgerId:"STOCK_JOURNAL_ADJUSTMENT",amount:p,inventoryAllocations:l},{id:`sj_entry_${s}_produce`,type:"Dr",ledgerId:"STOCK_JOURNAL_ADJUSTMENT",amount:p,inventoryAllocations:x}];v(D)},[g,v]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-x-2 gap-y-1 font-semibold text-slate-500 dark:text-slate-400 px-2 pb-2 text-sm border-b border-slate-300 dark:border-slate-600 min-w-[900px]",children:[e.jsx("div",{className:"col-span-3",children:"Item"}),e.jsx("div",{className:"col-span-2",children:"Source Godown"}),e.jsx("div",{className:"col-span-2",children:"Destination Godown"}),e.jsx("div",{className:"col-span-1",children:"Quantity"}),e.jsx("div",{className:"col-span-1",children:"Rate"}),e.jsx("div",{className:"col-span-2",children:"Amount"}),e.jsx("div",{className:"col-span-1"})]}),e.jsx("div",{className:"space-y-2 mt-2 min-w-[900px]",children:g.map((t,s)=>e.jsxs("div",{className:"grid grid-cols-12 gap-x-2 gap-y-1 items-start",children:[e.jsxs("div",{className:"col-span-3 flex items-start gap-2",children:[e.jsx(G,{label:"",id:`item-${s}`,value:t.stockItemId,onChange:l=>L(s,"stockItemId",l),options:m,className:"w-full"}),e.jsx(R,{type:"button",variant:"secondary",className:"!p-2 mt-1",onClick:()=>d(l=>L(s,"stockItemId",l.id)),children:e.jsx(O,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"col-span-2",children:e.jsx(G,{label:"",id:`source-${s}`,value:t.sourceGodownId,onChange:l=>L(s,"sourceGodownId",l),options:B})}),e.jsx("div",{className:"col-span-2",children:e.jsx(G,{label:"",id:`dest-${s}`,value:t.destGodownId,onChange:l=>L(s,"destGodownId",l),options:B})}),e.jsx("div",{className:"col-span-1",children:e.jsx(M,{label:"",id:`qty-${s}`,type:"number",value:t.quantity,onChange:l=>L(s,"quantity",parseFloat(l.target.value)||0)})}),e.jsx("div",{className:"col-span-1",children:e.jsx(M,{label:"",id:`rate-${s}`,type:"number",value:t.rate,onChange:l=>L(s,"rate",parseFloat(l.target.value)||0)})}),e.jsx("div",{className:"col-span-2",children:e.jsx(M,{label:"",id:`amount-${s}`,type:"number",value:t.amount.toFixed(2),readOnly:!0,className:"bg-slate-200 dark:bg-slate-800"})}),e.jsx("div",{className:"col-span-1 mt-1",children:e.jsx(R,{type:"button",variant:"danger",onClick:()=>_(s),className:"!p-2",children:e.jsx(z,{className:"w-5 h-5"})})})]},t.id))})]}),e.jsxs(R,{type:"button",variant:"secondary",onClick:S,children:[e.jsx(O,{className:"w-5 h-5 mr-2"}),"Add Item"]}),e.jsxs("div",{className:"text-right font-semibold text-slate-800 dark:text-slate-200 pt-2 border-t border-slate-300 dark:border-slate-700",children:["Total Value: ",e.jsx("span",{className:"font-mono",children:u.toFixed(2)})]})]})},be=({partyId:v,voucherType:I,amountToAllocate:$,existingAllocations:k,onSave:c})=>{const{companyData:h}=o.useContext(U),{vouchers:g}=h,{hideModal:f}=Q(),[m,B]=o.useState({}),L=o.useMemo(()=>{const t=I==="Payment"?"Purchase":"Sale",s=g.filter(p=>p.type===t&&p.entries.some(D=>D.ledgerId===v)),l=g.filter(p=>["Payment","Receipt","Credit Note","Debit Note"].includes(p.type)&&p.entries.some(D=>D.ledgerId===v)),x=new Map;return l.forEach(p=>{p.entries.forEach(D=>{var A;(A=D.billAllocations)==null||A.forEach(i=>{x.set(i.invoiceId,(x.get(i.invoiceId)||0)+i.amount)})})}),s.map(p=>{var V;const D=((V=p.entries.find(K=>K.ledgerId===v))==null?void 0:V.amount)||0,A=x.get(p.id)||0,i=D-A;return{id:p.id,date:p.date,voucherNo:p.voucherNo,amount:D,balance:i}}).filter(p=>p.balance>.01)},[v,I,g]);o.useEffect(()=>{if(k){const t=Object.fromEntries(k.map(s=>[s.invoiceId,s.amount]));B(t)}},[k]);const S=(t,s)=>{B(l=>({...l,[t]:s}))},_=o.useMemo(()=>Object.values(m).reduce((t,s)=>t+Number(s||0),0),[m]),d=$-_,u=()=>{if(_>$){alert("Total allocated amount cannot exceed the voucher amount.");return}const t=Object.entries(m).map(([s,l])=>({invoiceId:s,amount:parseFloat(String(l))||0})).filter(s=>s.amount>0);c(t),f()};return e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900 dark:text-slate-100 mb-4",children:"Bill-wise Settlement"}),e.jsxs("div",{className:"bg-slate-100 dark:bg-slate-700 p-3 rounded-lg mb-4 text-sm",children:[e.jsxs("div",{className:"flex justify-between font-semibold",children:[e.jsx("span",{children:"Amount to Allocate:"}),e.jsx("span",{className:"font-mono",children:$.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total Allocated:"}),e.jsx("span",{className:"font-mono",children:_.toFixed(2)})]}),e.jsxs("div",{className:`flex justify-between font-semibold ${d<0?"text-red-500":"text-green-500"}`,children:[e.jsx("span",{children:"Remaining:"}),e.jsx("span",{className:"font-mono",children:d.toFixed(2)})]})]}),e.jsxs("div",{className:"max-h-64 overflow-y-auto space-y-2 pr-2",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-2 font-semibold text-xs text-slate-500 dark:text-slate-400 border-b pb-1",children:[e.jsx("span",{children:"Bill Date"}),e.jsx("span",{children:"Bill No."}),e.jsx("span",{className:"text-right",children:"Balance"}),e.jsx("span",{className:"text-right",children:"Allocation"})]}),L.length>0?L.map(t=>e.jsxs("div",{className:"grid grid-cols-4 gap-2 items-center text-sm",children:[e.jsx("span",{children:ue(t.date)}),e.jsx("span",{children:t.voucherNo}),e.jsx("span",{className:"text-right font-mono",children:t.balance.toFixed(2)}),e.jsx(M,{label:"",id:`alloc-${t.id}`,type:"text",value:m[t.id]||"",onChange:s=>S(t.id,s.target.value),className:"text-right"})]},t.id)):e.jsx("p",{className:"text-center text-slate-500 py-4",children:"No outstanding bills found for this party."})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-4",children:[e.jsx(R,{variant:"secondary",onClick:f,children:"Cancel"}),e.jsxs(R,{onClick:u,children:[e.jsx(te,{className:"w-5 h-5 mr-2"})," Save Allocation"]})]})]})},fe=({entries:v,setEntries:I,onQuickCreateLedger:$,voucherType:k})=>{const{companyData:c}=o.useContext(U),{ledgers:h}=c,{showModal:g}=Q(),f=o.useMemo(()=>[{value:"",label:"Select Ledger"},...h.map(d=>({value:d.id,label:d.name}))],[h]),m=(d,u,t)=>{const s=[...v],l={...s[d]};l[u]=t,s[d]=l,I(s)},B=()=>{const d={id:`new_${Date.now()}`,type:"Dr",ledgerId:"",amount:0};I([...v,d])},L=d=>{I(v.filter((u,t)=>t!==d))},S=(d,u)=>{if(k!=="Payment"&&k!=="Receipt")return null;const t=h.find(x=>x.id===d.ledgerId);if(!t||!t.isBillWise||!["Sundry Debtors","Sundry Creditors"].includes(t.group))return null;const s=v.find(x=>{const p=h.find(D=>D.id===x.ledgerId);return p&&["Bank Accounts","Cash-in-hand"].includes(p.group)});if(!s||s.amount<=0)return null;const l=x=>{m(u,"billAllocations",x)};return e.jsx(R,{type:"button",variant:"secondary",className:"!p-2 mt-1",title:"Allocate Bills",onClick:()=>g(e.jsx(be,{partyId:d.ledgerId,voucherType:k,amountToAllocate:s.amount,existingAllocations:d.billAllocations,onSave:l})),children:e.jsx(le,{className:"w-5 h-5"})})},_=[{value:"Dr",label:"Dr"},{value:"Cr",label:"Cr"}];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-x-4 font-semibold text-slate-500 dark:text-slate-400 px-2 pb-2 border-b border-slate-300 dark:border-slate-600",children:[e.jsx("div",{className:"col-span-1",children:"By/To"}),e.jsx("div",{className:"col-span-6",children:"Particulars"}),e.jsx("div",{className:"col-span-4",children:"Amount"}),e.jsx("div",{className:"col-span-1"})]}),e.jsx("div",{className:"space-y-3",children:v.map((d,u)=>e.jsxs("div",{className:"grid grid-cols-12 gap-x-4 items-start",children:[e.jsx("div",{className:"col-span-1",children:e.jsx(G,{label:"",id:`type-${u}`,value:d.type,onChange:t=>m(u,"type",t),options:_})}),e.jsxs("div",{className:"col-span-6 flex items-start gap-2",children:[e.jsx(G,{label:"",id:`ledger-${u}`,value:d.ledgerId,onChange:t=>m(u,"ledgerId",t),options:f,className:"w-full"}),e.jsx(R,{type:"button",variant:"secondary",className:"!p-2 mt-1",onClick:()=>$(t=>m(u,"ledgerId",t.id)),children:e.jsx(O,{className:"w-5 h-5"})}),S(d,u)]}),e.jsx("div",{className:"col-span-4",children:e.jsx(M,{label:"",id:`amount-${u}`,type:"number",value:d.amount,onChange:t=>m(u,"amount",parseFloat(t.target.value)||0),min:"0",step:"0.01"})}),e.jsx("div",{className:"col-span-1 mt-1",children:e.jsx(R,{type:"button",variant:"danger",onClick:()=>L(u),className:"!p-2",disabled:v.length<=2,title:v.length<=2?"A voucher must have at least two entries":"Remove entry",children:e.jsx(z,{className:"w-5 h-5"})})})]},d.id))}),e.jsxs(R,{type:"button",variant:"secondary",onClick:B,className:"mt-2",children:[e.jsx(O,{className:"w-5 h-5 mr-2"}),"Add Row"]})]})},Se=()=>{var C;const v=ne(),I=re(),$=o.useContext(U),{addNotification:k}=Y(),{showModal:c}=Q(),{startDate:h,endDate:g}=oe(),f=(C=I.state)==null?void 0:C.voucherId,[m,B]=o.useState("Sale"),[L,S]=o.useState(1),[_,d]=o.useState(""),[u,t]=o.useState([]),[s,l]=o.useState("Intra-State"),[x,p]=o.useState(""),[D,A]=o.useState(Date.now());if(!$)return null;const{companyData:i,addVoucher:V,editVoucher:K}=$,P=["Sale","Purchase","Credit Note","Debit Note"].includes(m),E=m==="Stock Journal",H=o.useCallback(a=>{const T=(i==null?void 0:i.vouchers.filter(N=>N.type===a))||[];return(T.length>0?Math.max(...T.map(N=>N.voucherNo||0)):0)+1},[i==null?void 0:i.vouchers]);o.useEffect(()=>{if(f&&i){const a=i.vouchers.find(T=>T.id===f);a&&(B(a.type),S(a.voucherNo),d(a.date),t(a.entries),p(a.narration),l(a.transactionType||"Intra-State"),A(Date.now()))}else{S(H(m));const a=new Date,T=new Date(h),j=new Date(g);a.setHours(0,0,0,0),T.setHours(0,0,0,0),j.setHours(0,0,0,0),a>=T&&a<=j?d(new Date().toISOString().split("T")[0]):(d(g),k("Voucher date set to financial year end.","info"))}},[f,i,m,H,h,g,k]),o.useEffect(()=>{var a,T;if(!f){const j=Date.now(),N=[{id:`new_${j}_1`,type:"Dr",ledgerId:"",amount:0},{id:`new_${j}_2`,type:"Cr",ledgerId:"",amount:0}];if(m==="Payment"){const w=i==null?void 0:i.ledgers.filter(y=>y.group==="Cash-in-hand"||y.group==="Bank Accounts");N[1].ledgerId=((a=w==null?void 0:w[0])==null?void 0:a.id)||""}else if(m==="Receipt"){const w=i==null?void 0:i.ledgers.filter(y=>y.group==="Cash-in-hand"||y.group==="Bank Accounts");N[0].ledgerId=((T=w==null?void 0:w[0])==null?void 0:T.id)||""}!P&&!E?t(N):(t([]),A(Date.now()))}},[m,i==null?void 0:i.ledgers,P,E,f]);const X=a=>{c(e.jsx(se,{onLedgerCreated:a}))},W=()=>{var N,w;if(!P||!i)return;const a=(N=u.find(y=>{const F=i.ledgers.find(J=>J.id===y.ledgerId);return F&&["Sundry Debtors","Sundry Creditors","Bank Accounts","Cash-in-hand"].includes(F.group)}))==null?void 0:N.ledgerId,T=(w=u.find(y=>{const F=i.ledgers.find(J=>J.id===y.ledgerId);return F&&["Sales Accounts","Purchase Accounts"].includes(F.group)}))==null?void 0:w.ledgerId;if(!a||!T||u.length<2){k("Please fill in Party, Ledger, and at least one item before downloading.","error");return}const j={id:f||`temp_${Date.now()}`,date:_,type:m,voucherNo:L,entries:u,narration:x,transactionType:s};xe(j,i)},{debitTotal:Z,creditTotal:ee,isBalanced:q}=o.useMemo(()=>{const T=u.filter(j=>j.ledgerId&&j.amount>=0).reduce((j,N)=>{const w=Number(N.amount)||0;return N.type==="Dr"?j.debitTotal+=w:j.creditTotal+=w,j},{debitTotal:0,creditTotal:0});return{...T,isBalanced:Math.abs(T.debitTotal-T.creditTotal)<.01&&T.debitTotal>0}},[u]),n=a=>{if(a.preventDefault(),P&&(i!=null&&i.details.gstApplicable)){const w=new Set;s==="Intra-State"?(w.add("cgst"),w.add("sgst")):w.add("igst");const y=Array.from(w).filter(F=>!i.ledgers.some(J=>J.name.toLowerCase()===F&&J.group==="Duties & Taxes"));if(y.length>0){k(`Create ledgers under 'Duties & Taxes': ${y.join(", ").toUpperCase()}`,"error");return}}const T=u.filter(w=>w.ledgerId&&w.amount>=0);if(T.length<2){k("A voucher must have at least two valid entries.","error");return}if(!q){k("Debit and Credit totals must match and be greater than zero.","error");return}const j={date:_,type:m,voucherNo:L,entries:T,narration:x,transactionType:s};(f?K(f,j):V(j))&&(p(""),P&&l("Intra-State"),v(I.pathname,{replace:!0,state:{}}),A(Date.now()))},r=["Sale","Purchase","Credit Note","Debit Note","Payment","Receipt","Journal","Stock Journal"],b=f?"Edit Voucher":"Voucher Entry";return e.jsxs("div",{className:"w-full mx-auto",children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900 dark:text-slate-100 mb-6",children:b}),e.jsxs("form",{onSubmit:n,className:"bg-white dark:bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 space-y-6",children:[e.jsx("div",{className:"bg-slate-100 dark:bg-slate-900/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:[e.jsxs("div",{className:"w-full md:w-auto",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-800 dark:text-slate-300 mb-2",children:"Voucher Type"}),e.jsx("div",{className:"flex flex-wrap items-center gap-1",children:r.map(a=>e.jsx("button",{type:"button",onClick:()=>B(a),disabled:!!f,className:`px-4 py-2 text-sm font-semibold rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-slate-800 focus:ring-sky-500
                                            ${m===a?"bg-sky-600 text-white shadow":"text-slate-700 dark:text-slate-300 bg-slate-200 dark:bg-slate-700/50 hover:bg-slate-300 dark:hover:bg-slate-700"} 
                                            disabled:cursor-not-allowed disabled:bg-slate-600/50 disabled:text-slate-500 disabled:hover:bg-slate-600/50`,children:a},a))})]}),e.jsxs("div",{className:"flex items-center gap-4 flex-shrink-0 self-start md:self-end mt-4 md:mt-0",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-400 mb-1",children:"Vch No."}),e.jsx("div",{className:"px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-slate-900 dark:text-slate-100 min-w-[60px] text-center font-mono",children:L})]}),e.jsx(M,{label:"Date",id:"date",name:"date",type:"date",value:_,onChange:a=>d(a.target.value)})]})]})}),e.jsx("div",{className:"border-t border-slate-200 dark:border-slate-700 pt-6",children:P?e.jsx(ge,{voucherType:m,setVoucherEntries:t,setParentTransactionType:l,existingVoucher:f?i==null?void 0:i.vouchers.find(a=>a.id===f):void 0},D):E?e.jsx(pe,{setVoucherEntries:t},D):e.jsx(fe,{voucherType:m,entries:u,setEntries:t,onQuickCreateLedger:X},D)}),e.jsx("div",{children:e.jsx(ie,{label:"Narration",id:"narration",name:"narration",value:x,onChange:a=>p(a.target.value)})}),e.jsxs("div",{className:"bg-slate-100 dark:bg-slate-900/50 p-4 rounded-md flex justify-between items-center",children:[e.jsx("div",{className:"text-sm font-semibold",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("span",{className:"text-slate-600 dark:text-slate-300",children:["Debit Total: ",e.jsx("span",{className:"font-mono text-slate-800 dark:text-white",children:Z.toFixed(2)})]}),e.jsxs("span",{className:"text-slate-600 dark:text-slate-300",children:["Credit Total: ",e.jsx("span",{className:"font-mono text-slate-800 dark:text-white",children:ee.toFixed(2)})]})]})}),e.jsx("div",{className:`text-xs font-bold px-2 py-1 rounded-full ${q?"bg-green-500/10 text-green-500 dark:text-green-300":"bg-red-500/10 text-red-500 dark:text-red-400"}`,children:q?"BALANCED":"IMBALANCED"})]}),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t border-slate-200 dark:border-slate-700",children:[e.jsxs(R,{type:"button",variant:"secondary",onClick:W,disabled:!P,children:[e.jsx(de,{className:"w-5 h-5 mr-2"}),"Download PDF"]}),e.jsxs(R,{type:"submit",disabled:!q,children:[e.jsx(te,{className:"w-5 h-5 mr-2"}),f?"Update Entry":"Post Entry"]})]})]})]})};export{Se as default};
