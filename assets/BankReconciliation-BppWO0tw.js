import{r as l,C as Z,b as _,j as e,S as ee,B as R,U as te,m as ae}from"./index-D93vVwhB.js";import{c as se}from"./accounting-tZ5hxOR_.js";import{I as M}from"./Input-C3iYqBmf.js";import{f as E}from"./exportUtils-JZTId_Jh.js";const ce=()=>{const T=l.useContext(Z),{companyData:L,reconcileBankEntries:z}=T,{ledgers:x=[],vouchers:b=[]}=L,{addNotification:g}=_(),v=l.useRef(null),[o,O]=l.useState(""),[i,U]=l.useState(new Date().toISOString().split("T")[0]),[u,V]=l.useState(""),[p,k]=l.useState(new Set),$=l.useMemo(()=>[{value:"",label:"-- Select Bank --"},...x.filter(t=>t.group==="Bank Accounts"||t.group==="Bank OD A/c").map(t=>({value:t.id,label:t.name}))],[x]),C=l.useMemo(()=>{if(!o)return[];const t=new Map(x.map(a=>[a.id,a.name])),r=new Date(i);return r.setHours(23,59,59,999),b.flatMap(a=>a.entries.filter(n=>n.ledgerId===o).map(n=>{const c=a.entries.find(j=>j.ledgerId!==o);return{voucherId:a.id,date:a.date,particulars:t.get((c==null?void 0:c.ledgerId)||"")||a.narration||a.type,voucherType:a.type,voucherNo:a.voucherNo,entry:n}})).filter(a=>new Date(a.date)<=r).sort((a,n)=>new Date(a.date).getTime()-new Date(n.date).getTime())},[o,b,x,i]),f=l.useMemo(()=>C.filter(t=>!t.entry.reconciliationDate),[C]),{balanceAsPerBooks:q,unclearedPayments:H,unclearedReceipts:W,balanceAsPerBankCalc:G,difference:S}=l.useMemo(()=>{if(!o)return{balanceAsPerBooks:0,unclearedPayments:0,unclearedReceipts:0,balanceAsPerBankCalc:0,difference:0};const{closingBalances:t}=se(x,b,"1970-01-01",i),r=t.get(o)||0;let a=0,n=0;f.forEach(d=>{p.has(d.entry.id)||(d.entry.type==="Dr"?a+=d.entry.amount:n+=d.entry.amount)});const c=r-n+a,j=(u===""?c:u)-c;return{balanceAsPerBooks:r,unclearedPayments:a,unclearedReceipts:n,balanceAsPerBankCalc:c,difference:j}},[o,x,b,i,f,p,u]),J=t=>{k(r=>{const a=new Set(r);return a.has(t)?a.delete(t):a.add(t),a})},K=()=>{if(p.size===0){g("No entries selected to reconcile.","info");return}z(Array.from(p),i),k(new Set)},Q=t=>{var n;const r=(n=t.target.files)==null?void 0:n[0];if(!r)return;const a=new FileReader;a.onload=c=>{var D;const d=((D=c.target)==null?void 0:D.result).split(`
`).map(s=>s.trim()).filter(Boolean);if(d.length<2){g("CSV file is empty or has no data.","error");return}const A=d[0].split(",").map(s=>s.trim().toLowerCase()),N=A.findIndex(s=>s.includes("debit")||s.includes("withdrawal")),y=A.findIndex(s=>s.includes("credit")||s.includes("deposit"));if(N===-1&&y===-1){g("Could not find Debit/Credit or Withdrawal/Deposit columns in CSV.","error");return}const h=new Map;d.slice(1).forEach(s=>{var I,P;const m=s.split(","),X=N>-1?parseFloat((I=m[N])==null?void 0:I.replace(/["']/g,"")):0,Y=y>-1?parseFloat((P=m[y])==null?void 0:P.replace(/["']/g,"")):0,w=Math.abs(X||Y);if(!isNaN(w)&&w>0){const F=parseFloat(w.toFixed(2));h.set(F,(h.get(F)||0)+1)}});const B=new Set;f.forEach(s=>{const m=parseFloat(s.entry.amount.toFixed(2));h.has(m)&&(h.get(m)||0)>0&&(B.add(s.entry.id),h.set(m,(h.get(m)||1)-1))}),k(s=>new Set([...s,...B])),g(`Auto-matched ${B.size} transactions based on amount.`,"success")},a.readAsText(r)};return e.jsxs("div",{className:"container mx-auto",children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900 dark:text-slate-100 mb-6",children:"Bank Reconciliation"}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 mb-8 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-end",children:[e.jsx(ee,{label:"Bank Account",id:"bank-ledger",value:o,onChange:O,options:$,required:!0}),e.jsx(M,{label:"Reconciliation Date",id:"recon-date",type:"date",value:i,onChange:t=>U(t.target.value)}),e.jsx(M,{label:"Balance as per Bank Statement",id:"bank-balance",type:"number",value:u,onChange:t=>V(t.target.value===""?"":parseFloat(t.target.value)),placeholder:"Enter amount..."})]}),e.jsxs("div",{className:"pt-4 border-t border-slate-200 dark:border-slate-700 flex justify-end",children:[e.jsxs(R,{variant:"secondary",onClick:()=>{var t;return(t=v.current)==null?void 0:t.click()},children:[e.jsx(te,{className:"w-5 h-5 mr-2"}),"Import Statement (CSV)"]}),e.jsx("input",{type:"file",ref:v,onChange:Q,className:"hidden",accept:".csv"})]})]}),o&&e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-lg shadow-lg overflow-hidden border border-slate-200 dark:border-slate-700",children:[e.jsx("div",{className:"p-4",children:e.jsxs("h2",{className:"text-xl font-bold text-sky-600 dark:text-sky-300",children:["Unreconciled Transactions up to ",E(i)]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"text-left text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-900/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 font-medium",children:"Date"}),e.jsx("th",{className:"p-3 font-medium",children:"Particulars"}),e.jsx("th",{className:"p-3 font-medium text-right",children:"Debit (Payment)"}),e.jsx("th",{className:"p-3 font-medium text-right",children:"Credit (Receipt)"}),e.jsx("th",{className:"p-3 font-medium text-center",children:"Cleared"})]})}),e.jsx("tbody",{children:f.length>0?f.map(t=>e.jsxs("tr",{className:"border-b border-slate-200 dark:border-slate-700/50 hover:bg-slate-50 dark:hover:bg-slate-700/30",children:[e.jsx("td",{className:"p-3",children:E(t.date)}),e.jsx("td",{className:"p-3",children:t.particulars}),e.jsx("td",{className:"p-3 text-right font-mono text-orange-600 dark:text-orange-400",children:t.entry.type==="Dr"?t.entry.amount.toFixed(2):""}),e.jsx("td",{className:"p-3 text-right font-mono text-green-600 dark:text-green-400",children:t.entry.type==="Cr"?t.entry.amount.toFixed(2):""}),e.jsx("td",{className:"p-3 text-center",children:e.jsx("input",{type:"checkbox",checked:p.has(t.entry.id),onChange:()=>J(t.entry.id),className:"w-5 h-5 bg-slate-100 dark:bg-slate-700 border-slate-400 dark:border-slate-500 rounded text-sky-600 focus:ring-sky-500 cursor-pointer"})})]},t.entry.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-6 text-center text-slate-500 dark:text-slate-400",children:"All transactions are reconciled up to this date."})})})]})}),e.jsxs("div",{className:"p-6 bg-slate-100 dark:bg-slate-900/50 mt-4 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2 text-slate-700 dark:text-slate-300",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-semibold",children:"Balance as per Company Books:"})," ",e.jsx("span",{className:"font-mono",children:q.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between text-green-600 dark:text-green-400",children:[e.jsx("span",{className:"font-semibold",children:"Add: Payments not reflecting in Bank:"})," ",e.jsx("span",{className:"font-mono",children:H.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between text-orange-600 dark:text-orange-400",children:[e.jsx("span",{className:"font-semibold",children:"Less: Receipts not reflecting in Bank:"})," ",e.jsx("span",{className:"font-mono",children:W.toFixed(2)})]})]}),e.jsxs("div",{className:"space-y-2 text-slate-700 dark:text-slate-300 border-t md:border-t-0 md:border-l border-slate-200 dark:border-slate-700 pt-4 md:pt-0 md:pl-6",children:[e.jsxs("div",{className:"flex justify-between text-lg",children:[e.jsx("span",{className:"font-bold",children:"Balance as per Bank (Calculated):"})," ",e.jsx("span",{className:"font-mono font-bold",children:G.toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-semibold",children:"Balance as per Bank Statement:"})," ",e.jsx("span",{className:"font-mono",children:u!==""?u.toFixed(2):"N/A"})]}),e.jsxs("div",{className:`flex justify-between text-lg font-bold pt-2 mt-2 border-t border-slate-200 dark:border-slate-700 ${Math.abs(S)>.01?"text-red-600 dark:text-red-400":"text-green-600 dark:text-green-400"}`,children:[e.jsx("span",{children:"Difference:"})," ",e.jsx("span",{className:"font-mono",children:S.toFixed(2)})]})]})]}),e.jsx("div",{className:"p-4 flex justify-end",children:e.jsxs(R,{onClick:K,disabled:p.size===0,children:[e.jsx(ae,{className:"w-5 h-5 mr-2"})," Save Reconciliation"]})})]})]})};export{ce as default};
